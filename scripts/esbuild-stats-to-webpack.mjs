/**
 * Converts the esbuild metafile generated by `ng build --stats-json`
 * (from @angular/build:application) into the webpack stats format
 * expected by relative-ci/agent-action.
 *
 * Usage: node scripts/esbuild-stats-to-webpack.mjs <input> <output>
 *   input:  path to the esbuild metafile (e.g. dist/phased/stats.json)
 *   output: path to write the webpack stats JSON (e.g. dist/phased/webpack-stats.json)
 */

import { readFileSync, writeFileSync } from 'node:fs';

const [inputPath, outputPath] = process.argv.slice(2);
if (!inputPath || !outputPath) {
  console.error('Usage: node scripts/esbuild-stats-to-webpack.mjs <input> <output>');
  process.exit(1);
}

let metafile;
try {
  metafile = JSON.parse(readFileSync(inputPath, 'utf-8'));
} catch (err) {
  console.error(`Failed to read or parse input file "${inputPath}": ${err.message}`);
  process.exit(1);
}

// Map each output file (excluding source maps) to a webpack asset entry.
const assets = Object.entries(metafile.outputs)
  .filter(([name]) => !name.endsWith('.map'))
  .map(([name, info]) => ({
    name: name.replace(/^.*\/browser\//, ''),
    size: info.bytes,
  }));

// Map each input source file to a webpack module entry.
const modules = Object.entries(metafile.inputs).map(([name, info]) => ({
  name,
  size: info.bytes,
}));

const webpackStats = { assets, modules, chunks: [] };

writeFileSync(outputPath, JSON.stringify(webpackStats, null, 2));
console.log(`Wrote ${assets.length} assets and ${modules.length} modules to ${outputPath}`);
